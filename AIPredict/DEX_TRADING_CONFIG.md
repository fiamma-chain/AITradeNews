# DEX现货交易配置说明

**更新时间**: 2025-10-27  
**版本**: v1.1

---

## 📊 资金使用策略

### **DEX现货交易** (Uniswap/PancakeSwap)

DEX交易为**现货交易**，无杠杆，根据AI信心度动态调整资金使用比例：

| 信心度 | 资金使用比例 | 示例（100 USDC账户） |
|--------|--------------|---------------------|
| < 60% | 50% | 使用 50 USDC |
| 60% | 50% | 使用 50 USDC |
| 70% | 62.5% | 使用 62.5 USDC |
| 80% | 75% | 使用 75 USDC |
| 90% | 87.5% | 使用 87.5 USDC |
| 100% | 100% | 使用 100 USDC |

**计算公式**:
```python
if confidence < 60:
    amount_pct = 0.50  # 50%
else:
    # 线性映射: 60% -> 50%, 100% -> 100%
    amount_pct = 0.50 + ((confidence - 60) / 40) * 0.50

trade_amount = account_balance * amount_pct
```

---

### **CEX合约交易** (Hyperliquid/Aster)

CEX交易为**永续合约**，支持杠杆，根据信心度动态调整保证金和杠杆：

| 信心度 | 保证金比例 | 杠杆倍数 | 示例（100 USDC账户） |
|--------|-----------|----------|---------------------|
| < 60% | 30% | 10x | 保证金30U, 仓位300U |
| 60% | 30% | 10x | 保证金30U, 仓位300U |
| 70% | 47.5% | 20x | 保证金47.5U, 仓位950U |
| 80% | 65% | 30x | 保证金65U, 仓位1950U |
| 90% | 82.5% | 40x | 保证金82.5U, 仓位3300U |
| 100% | 100% | 50x | 保证金100U, 仓位5000U |

**计算公式**:
```python
# 保证金比例
if confidence < 60:
    margin_pct = 0.30  # 30%
else:
    # 线性映射: 60% -> 30%, 100% -> 100%
    margin_pct = 0.30 + ((confidence - 60) / 40) * 0.70

actual_margin = account_balance * margin_pct

# 杠杆倍数
if confidence < 60:
    leverage = 10
else:
    # 线性映射: 60% -> 10x, 100% -> 50x
    leverage = 10 + ((confidence - 60) / 40) * 40
```

---

## 🔄 交易对比

### **核心差异**

| 特性 | DEX现货 | CEX合约 |
|------|---------|---------|
| **交易类型** | 现货Swap | 永续合约 |
| **杠杆** | 1x（无杠杆） | 10-50x |
| **做空** | ❌ 不支持 | ✅ 支持 |
| **资金使用** | 50-100%余额 | 30-100%保证金 |
| **风险暴露** | 最多100%本金 | 可能爆仓 |
| **Gas费** | 需要ETH/BNB | 无 |
| **滑点** | 1%保护 | 极低 |
| **确认时间** | 12s (Base) / 3s (BSC) | <1s |

---

## 💡 策略说明

### **为什么DEX现货使用50-100%？**

1. **无杠杆风险**: 现货交易最多亏损本金，不会爆仓
2. **上币效应**: 新币上市初期波动大，收益潜力高
3. **流动性需求**: 足够的资金才能应对滑点
4. **机会成本**: DEX新币机会稀缺，应充分利用

### **为什么CEX合约使用30-100%？**

1. **杠杆放大**: 已经有10-50x杠杆，无需满仓
2. **爆仓风险**: 保留部分资金应对波动
3. **风险管理**: 分散风险，避免单次归零
4. **灵活性**: 保留资金用于其他机会

---

## 📈 实际案例

### **案例1: DEX现货交易 PING**

**场景**: Binance宣布PING上市，AI分析信心度80%

```
账户余额: 100 USDC
信心度: 80%
资金比例: 75% (线性映射)
交易金额: 75 USDC

操作: 用75 USDC买入PING
风险: 最多亏损75 USDC
潜在收益: 假设PING涨50% = 37.5 USDC利润
```

### **案例2: CEX合约交易 BTC**

**场景**: Binance宣布BTC合约新上市，AI分析信心度80%

```
账户余额: 100 USDC
信心度: 80%
保证金比例: 65%
杠杆: 30x
保证金: 65 USDC
仓位价值: 1950 USDC

操作: 用65U保证金开30x多单
风险: 价格下跌3.33%触发爆仓
潜在收益: 假设BTC涨10% = 195 USDC利润
```

---

## ⚙️ 配置文件

### **代码位置**

**DEX交易配置**: `news_trading/news_handler_dex.py`
```python
# 行 163-170
# 计算交易金额（DEX现货，无杠杆）
# 根据信心度使用50%-100%的余额（现货交易）
confidence = strategy.confidence
if confidence < 60:
    amount_pct = 0.50
else:
    # 60% -> 50%, 100% -> 100%
    amount_pct = 0.50 + ((confidence - 60) / 40) * 0.50
```

**CEX交易配置**: `news_trading/news_handler.py`
```python
# 行 191-203
# 根据信心度动态计算保证金比例
confidence = strategy.confidence
min_margin_pct = settings.news_min_margin_pct  # 0.30
max_margin_pct = settings.news_max_margin_pct  # 1.00

if confidence < 60:
    margin_pct = min_margin_pct
else:
    margin_pct = min_margin_pct + ((confidence - 60) / 40) * (max_margin_pct - min_margin_pct)
```

### **环境变量**

```bash
# CEX合约交易参数（在.env中配置）
NEWS_MIN_MARGIN_PCT=0.30  # 最小保证金比例 30%
NEWS_MAX_MARGIN_PCT=1.00  # 最大保证金比例 100%
NEWS_MIN_LEVERAGE=10      # 最小杠杆 10x
NEWS_MAX_LEVERAGE=50      # 最大杠杆 50x

# DEX现货交易参数（硬编码在代码中）
# 最小资金比例: 50%
# 最大资金比例: 100%
# 杠杆: 1x (现货无杠杆)
```

---

## 🎯 修改建议

### **如需调整DEX资金比例**

编辑 `news_trading/news_handler_dex.py` 第163-170行：

```python
# 示例: 改为40%-80%
if confidence < 60:
    amount_pct = 0.40  # 改为40%
else:
    # 60% -> 40%, 100% -> 80%
    amount_pct = 0.40 + ((confidence - 60) / 40) * 0.40  # 改为80%
```

### **如需调整CEX保证金比例**

编辑 `.env` 文件：

```bash
# 示例: 改为50%-100%
NEWS_MIN_MARGIN_PCT=0.50  # 改为50%
NEWS_MAX_MARGIN_PCT=1.00  # 保持100%
```

---

## 🔒 风险提示

### **DEX现货风险**

1. ✅ **优点**: 无杠杆，最多亏损本金
2. ⚠️ **风险**: 
   - 使用50-100%资金，单次交易风险集中
   - 新币流动性差，滑点可能超预期
   - Gas费固定成本，小额交易不划算

### **CEX合约风险**

1. ✅ **优点**: 杠杆放大收益，止损快速
2. ⚠️ **风险**: 
   - 高杠杆可能导致爆仓
   - 80%信心度已使用65%资金+30x杠杆
   - 价格快速波动可能来不及止损

---

## 📊 测试验证

### **DEX交易计算测试**

```python
# 测试不同信心度的资金使用
test_cases = [
    (50, 0.50),   # 信心度50% -> 使用50%
    (60, 0.50),   # 信心度60% -> 使用50%
    (70, 0.625),  # 信心度70% -> 使用62.5%
    (80, 0.75),   # 信心度80% -> 使用75%
    (90, 0.875),  # 信心度90% -> 使用87.5%
    (100, 1.0),   # 信心度100% -> 使用100%
]

account_balance = 100  # USDC

for confidence, expected_pct in test_cases:
    if confidence < 60:
        amount_pct = 0.50
    else:
        amount_pct = 0.50 + ((confidence - 60) / 40) * 0.50
    
    trade_amount = account_balance * amount_pct
    print(f"信心度{confidence}%: 使用{amount_pct*100:.1f}% = ${trade_amount:.2f}")
```

**预期输出**:
```
信心度50%: 使用50.0% = $50.00
信心度60%: 使用50.0% = $50.00
信心度70%: 使用62.5% = $62.50
信心度80%: 使用75.0% = $75.00
信心度90%: 使用87.5% = $87.50
信心度100%: 使用100.0% = $100.00
```

---

## 📈 分批止盈策略（DEX现货）

### **止盈规则**

DEX现货采用**分批止盈**策略，从20%涨幅开始分4批卖出：

| 涨幅阈值 | 卖出比例 | 批次 | 剩余持仓 |
|---------|---------|------|---------|
| 20% | 25% | 一批 | 75% |
| 30% | 25% | 二批 | 50% |
| 40% | 25% | 三批 | 25% |
| 50% | 25% | 四批 | 0% (完全止盈) |

### **策略说明**

1. **为什么分批止盈？**
   - 避免错过更大涨幅
   - 锁定部分利润，降低回撤风险
   - 优化收益曲线

2. **计算基准**
   - 所有批次基于**总持仓**计算
   - 例如：买入100个代币
     - 20%涨幅：卖出25个（25%总仓位）
     - 30%涨幅：卖出25个（累计50%）
     - 40%涨幅：卖出25个（累计75%）
     - 50%涨幅：卖出25个（全部卖出）

3. **监控频率**
   - 系统每5分钟检查一次DEX持仓
   - 自动触发止盈卖出
   - 记录每批次的利润

### **实际案例**

**案例：PING代币分批止盈**

```
初始买入:
- 成本: 100 USDC
- 数量: 100 PING
- 入场价: $1.00/PING

价格变化和操作:
1. 价格$1.20 (20%涨幅)
   - 卖出25 PING @ $1.20 = $30
   - 利润: $5 (成本$25)
   - 剩余: 75 PING

2. 价格$1.30 (30%涨幅)
   - 卖出25 PING @ $1.30 = $32.5
   - 利润: $7.5
   - 累计利润: $12.5
   - 剩余: 50 PING

3. 价格$1.40 (40%涨幅)
   - 卖出25 PING @ $1.40 = $35
   - 利润: $10
   - 累计利润: $22.5
   - 剩余: 25 PING

4. 价格$1.50 (50%涨幅)
   - 卖出25 PING @ $1.50 = $37.5
   - 利润: $12.5
   - 累计利润: $35
   - 剩余: 0 PING

总结:
- 总成本: $100
- 总收入: $135
- 总利润: $35
- ROI: 35%
- 平均卖出价: $1.35 (高于简单持有的$1.50风险)
```

### **与CEX止盈对比**

| 特性 | DEX现货分批止盈 | CEX合约一次性止盈 |
|------|----------------|------------------|
| **方式** | 4批次逐步卖出 | 达到目标全部平仓 |
| **起始** | 20%涨幅 | 30%涨幅 |
| **完成** | 50%涨幅 | 30%涨幅 |
| **风险** | 分散风险 | 集中风险 |
| **收益** | 优化平均价格 | 单一价格 |
| **灵活性** | 高（可继续持有部分） | 低（全部平仓） |

---

## ⚙️ 代码实现

### **持仓管理器位置**

`trading/dex/dex_position_manager.py`

### **核心配置**

```python
# 分批止盈配置
self.take_profit_levels = [
    {"threshold": 0.20, "sell_pct": 0.25, "label": "一批"},  # 20%涨幅
    {"threshold": 0.30, "sell_pct": 0.25, "label": "二批"},  # 30%涨幅
    {"threshold": 0.40, "sell_pct": 0.25, "label": "三批"},  # 40%涨幅
    {"threshold": 0.50, "sell_pct": 0.25, "label": "四批"},  # 50%涨幅
]
```

### **监控调用**

系统主循环中应定期调用：

```python
# 每5分钟监控一次DEX持仓
await dex_news_handler.monitor_dex_positions()
```

---

## 🎯 自定义止盈策略

### **如需修改止盈阈值**

编辑 `trading/dex/dex_position_manager.py` 第34-39行：

```python
# 示例1: 更激进的止盈（15%-40%）
self.take_profit_levels = [
    {"threshold": 0.15, "sell_pct": 0.25, "label": "一批"},
    {"threshold": 0.25, "sell_pct": 0.25, "label": "二批"},
    {"threshold": 0.35, "sell_pct": 0.25, "label": "三批"},
    {"threshold": 0.40, "sell_pct": 0.25, "label": "四批"},
]

# 示例2: 更保守的止盈（30%-80%）
self.take_profit_levels = [
    {"threshold": 0.30, "sell_pct": 0.25, "label": "一批"},
    {"threshold": 0.50, "sell_pct": 0.25, "label": "二批"},
    {"threshold": 0.65, "sell_pct": 0.25, "label": "三批"},
    {"threshold": 0.80, "sell_pct": 0.25, "label": "四批"},
]

# 示例3: 3批次止盈
self.take_profit_levels = [
    {"threshold": 0.25, "sell_pct": 0.33, "label": "一批"},  # 33%
    {"threshold": 0.40, "sell_pct": 0.33, "label": "二批"},  # 66%
    {"threshold": 0.55, "sell_pct": 0.34, "label": "三批"},  # 100%
]
```

---

## ✅ 更新日志

### v1.2 (2025-10-27)
- ✅ 添加DEX现货**分批止盈**功能
  - 20%/30%/40%/50%涨幅，分4批卖出
  - 每批卖出25%总持仓
- ✅ 创建`DEXPositionManager`持仓管理器
- ✅ 自动监控和执行止盈
- ✅ 详细利润记录和总结

### v1.1 (2025-10-27)
- ✅ 调整DEX现货资金使用比例: 10-50% → **50-100%**
- ✅ 添加详细策略说明文档
- ✅ 添加实际案例对比
- ✅ 添加测试验证代码

### v1.0 (2025-10-27)
- ✅ 初始版本：DEX 10-50%, CEX 30-100%

---

**更新完成！DEX现货交易现在支持：**
- ✅ 50-100%资金使用
- ✅ 20%-50%分批止盈（4批次）
- ✅ 自动监控和执行

🎉

